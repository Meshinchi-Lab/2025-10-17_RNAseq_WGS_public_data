//Create profiles to easily switch between the different process executors and platforms.
workDir = 'az://demo-azure-rnaseq/work'
resume = true
report.overwrite = true
dag.overwrite = true

// for custom github repo rnaseq
params {
    outdir = 'az://demo-azure-rnaseq/custom_rnaseq'
    sample_sheet = './rnaseq_count_nf_sample_sheet.csv'
    index = 'az://demo-azure-rnaseq/work/stage-29d2711a-f107-4cdd-84cd-bfd5878492b3/ea/2e8aaf13daeb08ea400260c9a2cd39/STARIndex'
    gtf = "${params.index}/genes.gtf"
    fasta = "${params.index}/genome.fa"
    rRNA_transcripts = 'results/ensembl_transcript_id_v114.txt'
    multiqc_config = 'https://raw.githubusercontent.com/Meshinchi-Lab/rnaseq_count_nf/refs/heads/main/multiqc_config.yml'
    user_settings = 'https://raw.githubusercontent.com/Meshinchi-Lab/rnaseq_count_nf/refs/heads/main/ncbi-user-settings.mkfg'
    build_index = false
    rerun_multiqc = false
}

// For nf-core RNA-seq
/*
params {
    outdir = 'az://demo-azure-rnaseq/custom_rnaseq'
}
*/

process {
    executor = 'azurebatch'
    // for nf-core pipelines with standardized labels
    withLabel: 'process_high' { 
        queue = 'high_mem'
    }
    withLabel: 'process_medium' { 
        queue = 'medium'
    }
    withLabel: '!process_high|process_medium' { 
        queue = 'small'
    }

    // for epi2me variant calling pipeline
    withName: 'readStats' { 
        queue = 'high_cpu'
    }
    withName: 'sv:*' { 
        queue = 'high_mem'
    }
    withName: 'snp:extract_not_haplotagged_contigs' {
        queue = 'high_cpu'
    }
}


//https://www.nextflow.io/docs/latest/azure.html
azure {
    managedIdentity {
        system = true
    }
    storage {
        accountName = 'cloudhpcstgaccount'
    }
    batch {
        location = 'italynorth'
        accountName = 'cloudhpcbatch'
        autoPoolMode = false
        //java.lang.IllegalArgumentException: Cannot find a VM for task 'NFCORE_RNASEQ:RNASEQ:FASTQ_QC_TRIM_FILTER_SETSTRANDEDNESS:FASTQ_FASTQC_UMITOOLS_TRIMGALORE:TRIMGALORE (K562_REP2)' matching these requirements: type=Standard_D4a_v4, cpus=12, mem=72 GB, location=italynorth
        allowPoolCreation = true
        deletePoolsOnCompletion = true 
        pools {
                // automatically scale pools
                small {
                    autoScale = true
                    vmType = 'Standard_D2ds_v5'
                    vmCount = 1
                    maxVmCount = 150
                    virtualNetwork = '/subscriptions/466a5f97-1f3f-4c8f-88d2-cf7432c4ff84/resourceGroups/CloudHPC/providers/Microsoft.Network/virtualNetworks/cloudhpcvnet/subnets/default'
                }
                medium {
                    autoScale = true
                    vmType = 'Standard_E8ds_v5'
                    vmCount = 1
                    maxVmCount = 50
                    virtualNetwork = '/subscriptions/466a5f97-1f3f-4c8f-88d2-cf7432c4ff84/resourceGroups/CloudHPC/providers/Microsoft.Network/virtualNetworks/cloudhpcvnet/subnets/default'
                }
                high_cpu {
                    autoScale = true
                    vmType = 'Standard_D16ds_v5'
                    vmCount = 1
                    maxVmCount = 10
                    virtualNetwork = '/subscriptions/466a5f97-1f3f-4c8f-88d2-cf7432c4ff84/resourceGroups/CloudHPC/providers/Microsoft.Network/virtualNetworks/cloudhpcvnet/subnets/default'
                }
                high_mem {
                    autoScale = true
                    vmType = 'Standard_E8ds_v5'
                    vmCount = 1
                    maxVmCount = 10
                    virtualNetwork = '/subscriptions/466a5f97-1f3f-4c8f-88d2-cf7432c4ff84/resourceGroups/CloudHPC/providers/Microsoft.Network/virtualNetworks/cloudhpcvnet/subnets/default'
                }
        }
    }
}

